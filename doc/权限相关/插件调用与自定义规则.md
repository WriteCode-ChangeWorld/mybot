## 插件调用与自定义规则

---

[TOC]

---



### 插件权限信息表

+ 插件类`__init__`函数内定义`level`属性，则`plugin_info`表内优先 使用该插件权限

  ```python
  self.level = 50
  ```

  插件类不包含`level`属性时，则**插件权限默认为10**

  ```python
  if not self.level:
      self.level = 10
  ```

  

+ 用户权限高于或等于插件权限`plugin_level`，则放行本次消息进入插件解析

+ 一般插件的插件权限设置为10，不开放/调试中/无限制群内使用的插件的插件权限可设置为30（建议）

| 字段             | 默认值 | 描述                                                         |
| ---------------- | ------ | ------------------------------------------------------------ |
| plugin           | N/A    | 插件类名称，如Bot_Ascii2d_Img                                |
| plugin_translate | N/A    | 插件中文名称，由开发者自定义，仅作展示；<br />若为空 (None)，则使用plugin展示 |
| plugin_level     | 10     | 插件权限，与普通用户权限持平                                 |

```mysql
// 插件权限信息表-sql
CREATE TABLE plugin_info(
    id int AUTO_INCREMENT PRIMARY KEY,
    plugin VARCHAR(40) NOT NULL,
    plugin_translate VARCHAR(40) NOT NULL,
    plugin_level INT(5) NOT NULL
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```





### 权限管理 (暂时滞后 没必要)

管理群组或用户的[某个/全部/指定权限等级]插件的权限，指定生效时间

| 字段     | 默认值 | 描述                                               |
| :------- | ------ | -------------------------------------------------- |
| id       |        | 自增id                                             |
| type     |        | 该条记录类型，用于区分是对群组的规则还是用户的规则 |
| group_id |        | 群组id                                             |
| user_id  |        | 用户id                                             |
| plugin   |        | 插件名，对应plugin_info表的plugin字段              |
| date     |        | 生效时间，2021-05-19 15:18:35                      |
| deadline |        | 到期时间，2021-05-19 15:18:45（10秒后）            |



### 案例场景

Q：如何做到每个插件对应每个群的权限？而且还需要可以动态更改，使用数据库。
A：~~具体到用户可以采用黑名单插件，而群权限的管理，无非于改动目标调用插件的最低用户权限~~
A2：更改插件权限即可，没必要太过于细化到群组/用户

A/B/C三个群，a1插件无限制用户权限，b1插件只有A群可使用(无限制);A群中用户123456限制使用
a1/b1两个插件；调用它们的所需的用户权限为：10/30



| id   | plugin | plugin_translate | plugin_level |
| ---- | ------ | ---------------- | ------------ |
| 1    | a1     | 测试插件1        | 10           |
| 2    | b1     | 测试插件2        | 30           |

