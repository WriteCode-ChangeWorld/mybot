### 1、脚本实现

#### raw payload

```python
// raw payload
{
    "query":"query ($ids: [Int]) {\n          Page(page: 1, perPage: 50) {\n            media(id_in: $ids, type: ANIME) {\n              id\n              title {\n                native\n                romaji\n                english\n              }\n              type\n              format\n              status\n              startDate {\n                year\n                month\n                day\n              }\n              endDate {\n                year\n                month\n                day\n              }\n              season\n              episodes\n              duration\n              source\n              coverImage {\n                large\n                medium\n              }\n              bannerImage\n              genres\n              synonyms\n              studios {\n                edges {\n                  isMain\n                  node {\n                    id\n                    name\n                    siteUrl\n                  }\n                }\n              }\n              isAdult\n              externalLinks {\n                id\n                url\n                site\n              }\n              siteUrl\n            }\n          }\n        }\n        ",
"variables":{"ids":[97716]}
}
```

#### 脚本实现

```python
import json
import requests

anilist_url = "https://trace.moe/anilist/"
anime_id = "97716"
headers = {
    "user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
    "content-type":"application/json"
}
# 修改perPage 10 -> 1
# 优化后的graphQL语句见第五点,resp同理
payload = {
    "query": """query ($ids: [Int]) {
        Page(page: 1, perPage: 1) {
            media(id_in: $ids, type: ANIME) {
                id
                title {
                    native
                    romaji
                    english
                    }
                type
                format
                status
                startDate {
                    year
                    month
                    day
                    }
                endDate {
                    year
                    month
                    day
                    }
                season
                episodes
                duration
                source
                coverImage {
                    large
                    medium
                    }
                bannerImage
                genres
                synonyms
                studios {
                    edges {
                        isMain
                        node {
                            id
                            name
                            siteUrl
                            }
                        }
                    }
                isAdult
                externalLinks {
                    id
                    url
                    site
                    }
                siteUrl
                }
            }
        }""",
    "variables": {"ids": [str(anime_id)]}
}

resp = requests.post(anilist_url,data=json.dumps(payload),headers=headers,timeout=5)
print(resp.text)
```

#### **response**

```json
{
    "data": {
        "Page": {
            "media": [
                {
                    "id": 97716,
                    "title": {
                        "native": "月曜日のたわわ",
                        "romaji": "Getsuyoubi no Tawawa",
                        "english": "Tawawa on Monday",
                        "chinese": "月曜日のたわわ"
                    },
                    "type": "ANIME",
                    "format": "ONA",
                    "status": "FINISHED",
                    "startDate": {
                        "year": 2016,
                        "month": 10,
                        "day": 10
                    },
                    "endDate": {
                        "year": 2016,
                        "month": 12,
                        "day": 26
                    },
                    "season": "FALL",
                    "episodes": 12,
                    "duration": 5,
                    "source": "OTHER",
                    "coverImage": {
                        "large": "https://s4.anilist.co/file/anilistcdn/media/anime/cover/medium/97716-Kf3SXRjuc0TV.jpg",
                        "medium": "https://s4.anilist.co/file/anilistcdn/media/anime/cover/small/97716-Kf3SXRjuc0TV.jpg"
                    },
                    "bannerImage": "https://s4.anilist.co/file/anilistcdn/media/anime/banner/97716-sEp8G2X0wAIk.jpg",
                    "genres": [
                        "Ecchi",
                        "Slice of Life"
                    ],
                    "synonyms": [
                        "週一的豐饒",
                        "週一的碩果",
                        "週一桃夭夭",
                        "搖搖的週一",
                        "星期一的福利",
                        "星期一的大咪咪",
                        "星期一的豐滿",
                        "軟綿綿的星期一",
                        "搖曳的星期一"
                    ],
                    "studios": {
                        "edges": [
                            {
                                "isMain": true,
                                "node": {
                                    "id": 6103,
                                    "name": "PINE JAM",
                                    "siteUrl": "https://anilist.co/studio/6103"
                                }
                            }
                        ]
                    },
                    "isAdult": false,
                    "externalLinks": [],
                    "siteUrl": "https://anilist.co/anime/97716"
                }
            ]
        }
    }
}
```



### 2、response数据备份

---

#### a、what anime搜番结果，通过网络图片链接

https://api.trace.moe/search

**非gif图片，不用自己Post上传，用接口即可。**

https://api.trace.moe/search?url=https://ascii2d.net/thumbnail/9/3/0/c/930c8c357f277eef71c997a309ca11b4.jpg

```json
{"frameCount":10365180,"error":"","result":[{"anilist":21455,"filename":"[Leopard-Raws] New Game! - 05 RAW (ATX 1280x720 x264 AAC).mp4","episode":5,"from":557,"to":558.83,"similarity":0.8342350877745852,"video":"https://media.trace.moe/video/21455/%5BLeopard-Raws%5D%20New%20Game!%20-%2005%20RAW%20(ATX%201280x720%20x264%20AAC).mp4?t=557.915&token=BRl1tIabZqCM3EAc877VR9ctc90","image":"https://media.trace.moe/image/21455/%5BLeopard-Raws%5D%20New%20Game!%20-%2005%20RAW%20(ATX%201280x720%20x264%20AAC).mp4?t=557.915&token=BRl1tIabZqCM3EAc877VR9ctc90"},{"anilist":21455,"filename":"[Ohys-Raws] New Game! - 05 (AT-X 1280x720 x264 AAC).mp4","episode":5,"from":555.42,"to":559,"similarity":0.8342350877745852,"video":"https://media.trace.moe/video/21455/%5BOhys-Raws%5D%20New%20Game!%20-%2005%20(AT-X%201280x720%20x264%20AAC).mp4?t=557.21&token=IU4VlaKikUJKflVjIa5QCqRRrg","image":"https://media.trace.moe/image/21455/%5BOhys-Raws%5D%20New%20Game!%20-%2005%20(AT-X%201280x720%20x264%20AAC).mp4?t=557.21&token=IU4VlaKikUJKflVjIa5QCqRRrg"},{"anilist":97716,"filename":"Getsuyoubi no Tawawa - 14 (BD 1280x720 x264 AAC).mp4","episode":14,"from":276.5,"to":280.25,"similarity":0.8331655485913178,"video":"https://media.trace.moe/video/97716/Getsuyoubi%20no%20Tawawa%20-%2014%20(BD%201280x720%20x264%20AAC).mp4?t=278.375&token=ZQlx9aYF55xAvOjOwXnqnNQB0","image":"https://media.trace.moe/image/97716/Getsuyoubi%20no%20Tawawa%20-%2014%20(BD%201280x720%20x264%20AAC).mp4?t=278.375&token=ZQlx9aYF55xAvOjOwXnqnNQB0"},{"anilist":21455,"filename":"New Game! - 05 (BD 1280x720 x264 AAC).mp4","episode":5,"from":546.5,"to":548.67,"similarity":0.8304789621728003,"video":"https://media.trace.moe/video/21455/New%20Game!%20-%2005%20(BD%201280x720%20x264%20AAC).mp4?t=547.585&token=lU8KXsX85U8RjbtkNRjqfkuzgQ","image":"https://media.trace.moe/image/21455/New%20Game!%20-%2005%20(BD%201280x720%20x264%20AAC).mp4?t=547.585&token=lU8KXsX85U8RjbtkNRjqfkuzgQ"},{"anilist":103222,"filename":"[Leopard-Raws] Mahou Shoujo Tokushusen Asuka - 03 RAW (TBS 1280x720 x264 AAC).mp4","episode":3,"from":1023.42,"to":1023.75,"similarity":0.823369580867275,"video":"https://media.trace.moe/video/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.585&token=0DVLf48FHjmA3u0EiaTzD6rzzk","image":"https://media.trace.moe/image/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.585&token=0DVLf48FHjmA3u0EiaTzD6rzzk"},{"anilist":103222,"filename":"[Ohys-Raws] Mahou Shoujo Tokushusen Asuka - 02 (TBS 1280x720 x264 AAC).mp4","episode":2,"from":1441.08,"to":1441.42,"similarity":0.823369580867275,"video":"https://media.trace.moe/video/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(TBS%201280x720%20x264%20AAC).mp4?t=1441.25&token=tVCaYdWVYYpjgvLLDQYsdc1kJI","image":"https://media.trace.moe/image/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(TBS%201280x720%20x264%20AAC).mp4?t=1441.25&token=tVCaYdWVYYpjgvLLDQYsdc1kJI"},{"anilist":103222,"filename":"Mahou Shoujo Tokushusen Asuka - 03 (BD 1280x720 x264 AAC).mp4","episode":3,"from":1024.5,"to":1024.83,"similarity":0.8211145618000169,"video":"https://media.trace.moe/video/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(BD%201280x720%20x264%20AAC).mp4?t=1024.665&token=KfjnRI81VWKsNXNiNv94fyI2cHQ","image":"https://media.trace.moe/image/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(BD%201280x720%20x264%20AAC).mp4?t=1024.665&token=KfjnRI81VWKsNXNiNv94fyI2cHQ"},{"anilist":20922,"filename":"[Leopard-Raws] Yoru no Yatterman - 06 RAW (MX 1280x720 x264 AAC).mp4","episode":6,"from":1146.92,"to":1148.83,"similarity":0.8210515407106077,"video":"https://media.trace.moe/video/20922/%5BLeopard-Raws%5D%20Yoru%20no%20Yatterman%20-%2006%20RAW%20(MX%201280x720%20x264%20AAC).mp4?t=1147.875&token=3hsQB0y03RM13CmS9r52ASTA7Fk","image":"https://media.trace.moe/image/20922/%5BLeopard-Raws%5D%20Yoru%20no%20Yatterman%20-%2006%20RAW%20(MX%201280x720%20x264%20AAC).mp4?t=1147.875&token=3hsQB0y03RM13CmS9r52ASTA7Fk"},{"anilist":20922,"filename":"Yoru no Yatterman - 06 (BD 1280x720 x264 AAC).mp4","episode":6,"from":1137.17,"to":1138.92,"similarity":0.8210515407106077,"video":"https://media.trace.moe/video/20922/Yoru%20no%20Yatterman%20-%2006%20(BD%201280x720%20x264%20AAC).mp4?t=1138.045&token=ervGisGBz6vyB9rJbIZ38pPwXH0","image":"https://media.trace.moe/image/20922/Yoru%20no%20Yatterman%20-%2006%20(BD%201280x720%20x264%20AAC).mp4?t=1138.045&token=ervGisGBz6vyB9rJbIZ38pPwXH0"},{"anilist":9969,"filename":"[SOSG][Gintama][241][X264_AAC][720p][HDTV].mp4","episode":241,"from":6.42,"to":7.75,"similarity":0.8204906540435711,"video":"https://media.trace.moe/video/9969/%5BSOSG%5D%5BGintama%5D%5B241%5D%5BX264_AAC%5D%5B720p%5D%5BHDTV%5D.mp4?t=7.085&token=PbmNAYFpe2SoNOqMD1Y3tkKk","image":"https://media.trace.moe/image/9969/%5BSOSG%5D%5BGintama%5D%5B241%5D%5BX264_AAC%5D%5B720p%5D%5BHDTV%5D.mp4?t=7.085&token=PbmNAYFpe2SoNOqMD1Y3tkKk"}]}
```

#### b、what anime搜番结果，通过本地图片

https://api.trace.moe/search

```json
{"frameCount":10365180,"error":"","result":[{"anilist":97716,"filename":"Getsuyoubi no Tawawa - 14 (BD 1280x720 x264 AAC).mp4","episode":14,"from":276.5,"to":280.25,"similarity":0.8421454990736311,"video":"https://media.trace.moe/video/97716/Getsuyoubi%20no%20Tawawa%20-%2014%20(BD%201280x720%20x264%20AAC).mp4?t=278.375&token=ZQlx9aYF55xAvOjOwXnqnNQB0","image":"https://media.trace.moe/image/97716/Getsuyoubi%20no%20Tawawa%20-%2014%20(BD%201280x720%20x264%20AAC).mp4?t=278.375&token=ZQlx9aYF55xAvOjOwXnqnNQB0"},{"anilist":21455,"filename":"[Leopard-Raws] New Game! - 05 RAW (ATX 1280x720 x264 AAC).mp4","episode":5,"from":557,"to":558.83,"similarity":0.8355080369714701,"video":"https://media.trace.moe/video/21455/%5BLeopard-Raws%5D%20New%20Game!%20-%2005%20RAW%20(ATX%201280x720%20x264%20AAC).mp4?t=557.915&token=BRl1tIabZqCM3EAc877VR9ctc90","image":"https://media.trace.moe/image/21455/%5BLeopard-Raws%5D%20New%20Game!%20-%2005%20RAW%20(ATX%201280x720%20x264%20AAC).mp4?t=557.915&token=BRl1tIabZqCM3EAc877VR9ctc90"},{"anilist":21455,"filename":"[Ohys-Raws] New Game! - 05 (AT-X 1280x720 x264 AAC).mp4","episode":5,"from":555.42,"to":559,"similarity":0.8355080369714701,"video":"https://media.trace.moe/video/21455/%5BOhys-Raws%5D%20New%20Game!%20-%2005%20(AT-X%201280x720%20x264%20AAC).mp4?t=557.21&token=IU4VlaKikUJKflVjIa5QCqRRrg","image":"https://media.trace.moe/image/21455/%5BOhys-Raws%5D%20New%20Game!%20-%2005%20(AT-X%201280x720%20x264%20AAC).mp4?t=557.21&token=IU4VlaKikUJKflVjIa5QCqRRrg"},{"anilist":103222,"filename":"[Leopard-Raws] Mahou Shoujo Tokushusen Asuka - 03 RAW (TBS 1280x720 x264 AAC).mp4","episode":3,"from":1023.5,"to":1023.75,"similarity":0.831866486362662,"video":"https://media.trace.moe/video/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.625&token=Bv8vA3fhWEVcKxbrIlh9JupqY","image":"https://media.trace.moe/image/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.625&token=Bv8vA3fhWEVcKxbrIlh9JupqY"},{"anilist":103222,"filename":"[Ohys-Raws] Mahou Shoujo Tokushusen Asuka - 02 (TBS 1280x720 x264 AAC).mp4","episode":2,"from":1441.08,"to":1441.42,"similarity":0.831866486362662,"video":"https://media.trace.moe/video/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(TBS%201280x720%20x264%20AAC).mp4?t=1441.25&token=tVCaYdWVYYpjgvLLDQYsdc1kJI","image":"https://media.trace.moe/image/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(TBS%201280x720%20x264%20AAC).mp4?t=1441.25&token=tVCaYdWVYYpjgvLLDQYsdc1kJI"},{"anilist":21455,"filename":"New Game! - 05 (BD 1280x720 x264 AAC).mp4","episode":5,"from":546.5,"to":548.67,"similarity":0.8317157287525382,"video":"https://media.trace.moe/video/21455/New%20Game!%20-%2005%20(BD%201280x720%20x264%20AAC).mp4?t=547.585&token=lU8KXsX85U8RjbtkNRjqfkuzgQ","image":"https://media.trace.moe/image/21455/New%20Game!%20-%2005%20(BD%201280x720%20x264%20AAC).mp4?t=547.585&token=lU8KXsX85U8RjbtkNRjqfkuzgQ"},{"anilist":103222,"filename":"Mahou Shoujo Tokushusen Asuka - 03 (BD 1280x720 x264 AAC).mp4","episode":3,"from":1024.5,"to":1024.83,"similarity":0.8295518438430932,"video":"https://media.trace.moe/video/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(BD%201280x720%20x264%20AAC).mp4?t=1024.665&token=KfjnRI81VWKsNXNiNv94fyI2cHQ","image":"https://media.trace.moe/image/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(BD%201280x720%20x264%20AAC).mp4?t=1024.665&token=KfjnRI81VWKsNXNiNv94fyI2cHQ"},{"anilist":103222,"filename":"[Ohys-Raws] Mahou Shoujo Tokushusen Asuka - 03 (TBS 1280x720 x264 AAC).mp4","episode":3,"from":1023.67,"to":1024,"similarity":0.8288949558628909,"video":"https://media.trace.moe/video/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.835&token=xlwp97NHEPIt0W8LsrsWziUsnU","image":"https://media.trace.moe/image/103222/%5BOhys-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2003%20(TBS%201280x720%20x264%20AAC).mp4?t=1023.835&token=xlwp97NHEPIt0W8LsrsWziUsnU"},{"anilist":103222,"filename":"Mahou Shoujo Tokushusen Asuka - 02 (BD 1280x720 x264 AAC).mp4","episode":2,"from":1441.92,"to":1442.17,"similarity":0.8268723519187818,"video":"https://media.trace.moe/video/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(BD%201280x720%20x264%20AAC).mp4?t=1442.045&token=ZER779POhc9LNqYlxClModcuj4","image":"https://media.trace.moe/image/103222/Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20(BD%201280x720%20x264%20AAC).mp4?t=1442.045&token=ZER779POhc9LNqYlxClModcuj4"},{"anilist":103222,"filename":"[Leopard-Raws] Mahou Shoujo Tokushusen Asuka - 02 RAW (TBS 1280x720 x264 AAC).mp4","episode":2,"from":1440.83,"to":1441.17,"similarity":0.8265279305467168,"video":"https://media.trace.moe/video/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1441&token=Xye5lq0apCQmOkjbcrDgj3HmY","image":"https://media.trace.moe/image/103222/%5BLeopard-Raws%5D%20Mahou%20Shoujo%20Tokushusen%20Asuka%20-%2002%20RAW%20(TBS%201280x720%20x264%20AAC).mp4?t=1441&token=Xye5lq0apCQmOkjbcrDgj3HmY"}]}
```

#### c、【当前】what anime搜番结果，通过url传参

```
https://trace.moe/api/search?url=https://ascii2d.net/thumbnail/9/3/0/c/930c8c357f277eef71c997a309ca11b4.jpg
```

```json
{"RawDocsCount":10365180,"CacheHit":false,"trial":1,"limit":10,"limit_ttl":60,"quota":1000,"quota_ttl":86400,"RawDocsSearchTime":0,"ReRankSearchTime":0,"docs":[{"filename":"[Leopard-Raws] New Game! - 05 RAW (ATX 1280x720 x264 AAC).mp4","episode":5,"from":557,"to":558.83,"similarity":0.8342350877745852,"anilist_id":21455,"anime":"NEW GAME!","at":557.915,"is_adult":false,"mal_id":31953,"season":"","synonyms":[],"synonyms_chinese":[],"title":"NEW GAME!","title_chinese":"NEW GAME!","title_english":"NEW GAME!","title_native":"NEW GAME!","title_romaji":"NEW GAME!","tokenthumb":"BRl1tIabZqCM3EAc877VR9ctc90"},{"filename":"[Ohys-Raws] New Game! - 05 (AT-X 1280x720 x264 AAC).mp4","episode":5,"from":555.42,"to":559,"similarity":0.8342350877745852,"anilist_id":21455,"anime":"NEW GAME!","at":557.21,"is_adult":false,"mal_id":31953,"season":"","synonyms":[],"synonyms_chinese":[],"title":"NEW GAME!","title_chinese":"NEW GAME!","title_english":"NEW GAME!","title_native":"NEW GAME!","title_romaji":"NEW GAME!","tokenthumb":"IU4VlaKikUJKflVjIa5QCqRRrg"},{"filename":"Getsuyoubi no Tawawa - 14 (BD 1280x720 x264 AAC).mp4","episode":14,"from":276.5,"to":280.25,"similarity":0.8331655485913178,"anilist_id":97716,"anime":"\u6708\u66dc\u65e5\u306e\u305f\u308f\u308f","at":278.375,"is_adult":false,"mal_id":34213,"season":"","synonyms":[],"synonyms_chinese":["\u9031\u4e00\u7684\u8c50\u9952","\u9031\u4e00\u7684\u78a9\u679c","\u9031\u4e00\u6843\u592d\u592d","\u6416\u6416\u7684\u9031\u4e00","\u661f\u671f\u4e00\u7684\u798f\u5229","\u661f\u671f\u4e00\u7684\u5927\u54aa\u54aa","\u661f\u671f\u4e00\u7684\u8c50\u6eff","\u8edf\u7dbf\u7dbf\u7684\u661f\u671f\u4e00","\u6416\u66f3\u7684\u661f\u671f\u4e00"],"title":"\u6708\u66dc\u65e5\u306e\u305f\u308f\u308f","title_chinese":"\u6708\u66dc\u65e5\u306e\u305f\u308f\u308f","title_english":"Tawawa on Monday","title_native":"\u6708\u66dc\u65e5\u306e\u305f\u308f\u308f","title_romaji":"Getsuyoubi no Tawawa","tokenthumb":"ZQlx9aYF55xAvOjOwXnqnNQB0"},{"filename":"New Game! - 05 (BD 1280x720 x264 AAC).mp4","episode":5,"from":546.5,"to":548.67,"similarity":0.8304789621728003,"anilist_id":21455,"anime":"NEW GAME!","at":547.585,"is_adult":false,"mal_id":31953,"season":"","synonyms":[],"synonyms_chinese":[],"title":"NEW GAME!","title_chinese":"NEW GAME!","title_english":"NEW GAME!","title_native":"NEW GAME!","title_romaji":"NEW GAME!","tokenthumb":"lU8KXsX85U8RjbtkNRjqfkuzgQ"},{"filename":"[Leopard-Raws] Mahou Shoujo Tokushusen Asuka - 03 RAW (TBS 1280x720 x264 AAC).mp4","episode":3,"from":1023.42,"to":1023.75,"similarity":0.823369580867275,"anilist_id":103222,"anime":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","at":1023.585,"is_adult":false,"mal_id":37979,"season":"","synonyms":[],"synonyms_chinese":[],"title":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_chinese":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","title_english":"Magical Girl Spec-Ops Asuka","title_native":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_romaji":"Mahou Shoujo Tokushusen Asuka","tokenthumb":"0DVLf48FHjmA3u0EiaTzD6rzzk"},{"filename":"[Ohys-Raws] Mahou Shoujo Tokushusen Asuka - 02 (TBS 1280x720 x264 AAC).mp4","episode":2,"from":1441.08,"to":1441.42,"similarity":0.823369580867275,"anilist_id":103222,"anime":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","at":1441.25,"is_adult":false,"mal_id":37979,"season":"","synonyms":[],"synonyms_chinese":[],"title":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_chinese":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","title_english":"Magical Girl Spec-Ops Asuka","title_native":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_romaji":"Mahou Shoujo Tokushusen Asuka","tokenthumb":"tVCaYdWVYYpjgvLLDQYsdc1kJI"},{"filename":"Mahou Shoujo Tokushusen Asuka - 03 (BD 1280x720 x264 AAC).mp4","episode":3,"from":1024.5,"to":1024.83,"similarity":0.8211145618000169,"anilist_id":103222,"anime":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","at":1024.665,"is_adult":false,"mal_id":37979,"season":"","synonyms":[],"synonyms_chinese":[],"title":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_chinese":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6230\u660e\u65e5\u9999","title_english":"Magical Girl Spec-Ops Asuka","title_native":"\u9b54\u6cd5\u5c11\u5973\u7279\u6b8a\u6226\u3042\u3059\u304b","title_romaji":"Mahou Shoujo Tokushusen Asuka","tokenthumb":"KfjnRI81VWKsNXNiNv94fyI2cHQ"},{"filename":"[Leopard-Raws] Yoru no Yatterman - 06 RAW (MX 1280x720 x264 AAC).mp4","episode":6,"from":1146.92,"to":1148.83,"similarity":0.8210515407106077,"anilist_id":20922,"anime":"\u591c\u4e4b\u5c0f\u96d9\u4fe0","at":1147.875,"is_adult":false,"mal_id":28155,"season":"","synonyms":[],"synonyms_chinese":["\u591c\u665a\u7684\u5c0f\u96d9\u4fe0","\u591c\u665a\u7684\u6b63\u7fa9\u96d9\u4fe0"],"title":"\u591c\u30ce\u30e4\u30c3\u30bf\u30fc\u30de\u30f3","title_chinese":"\u591c\u4e4b\u5c0f\u96d9\u4fe0","title_english":"Yatterman Night","title_native":"\u591c\u30ce\u30e4\u30c3\u30bf\u30fc\u30de\u30f3","title_romaji":"Yoru no Yatterman","tokenthumb":"3hsQB0y03RM13CmS9r52ASTA7Fk"},{"filename":"Yoru no Yatterman - 06 (BD 1280x720 x264 AAC).mp4","episode":6,"from":1137.17,"to":1138.92,"similarity":0.8210515407106077,"anilist_id":20922,"anime":"\u591c\u4e4b\u5c0f\u96d9\u4fe0","at":1138.045,"is_adult":false,"mal_id":28155,"season":"","synonyms":[],"synonyms_chinese":["\u591c\u665a\u7684\u5c0f\u96d9\u4fe0","\u591c\u665a\u7684\u6b63\u7fa9\u96d9\u4fe0"],"title":"\u591c\u30ce\u30e4\u30c3\u30bf\u30fc\u30de\u30f3","title_chinese":"\u591c\u4e4b\u5c0f\u96d9\u4fe0","title_english":"Yatterman Night","title_native":"\u591c\u30ce\u30e4\u30c3\u30bf\u30fc\u30de\u30f3","title_romaji":"Yoru no Yatterman","tokenthumb":"ervGisGBz6vyB9rJbIZ38pPwXH0"},{"filename":"[SOSG][Gintama][241][X264_AAC][720p][HDTV].mp4","episode":241,"from":6.42,"to":7.75,"similarity":0.8204906540435711,"anilist_id":9969,"anime":"\u9280\u9b42'","at":7.085,"is_adult":false,"mal_id":9969,"season":"","synonyms":["Gintama (2011)"],"synonyms_chinese":[],"title":"\u9280\u9b42\u2019","title_chinese":"\u9280\u9b42'","title_english":"Gintama Season 2","title_native":"\u9280\u9b42\u2019","title_romaji":"Gintama'","tokenthumb":"PbmNAYFpe2SoNOqMD1Y3tkKk"}]}
```







### 3、测试用例

异常图片

```
http://gchat.qpic.cn/gchatpic_new/3012797743/1072957655-2360087874-5E82997DBCC66854354A8B5BA4B9682A/0?term=3
```

星期一的丰满

```
https://ascii2d.net/thumbnail/9/3/0/c/930c8c357f277eef71c997a309ca11b4.jpg
```



a、c：https://ascii2d.net/thumbnail/9/3/0/c/930c8c357f277eef71c997a309ca11b4.jpg

result：New Game！×



b：gif

result：星期一的丰满√





### 4、当前对策：添加补丁，修复服务器端文件

```python
# gif
# 下载 强转 编码 上传
# 非gif
# 接口 url字段传参

# 必须步骤,在anilist查询番剧信息

# 先不考虑私聊,
```





trace_url: https://trace.moe/api/search?url=xxxxxxx

通过网络链接搜番: https://trace.moe/api/search?url=xxx

新接口POST图片二进制数据: https://api.trace.moe/search?info=advanced&cutBorders=1&anilistID=

```markdown
# temp
(80.77%) EP#2 5分2秒
原始名称: Slow Start
中文名称: Slow Start
番剧封面: 
[图片]

搜番预览链接: http://j8f.net/mweff
```







### 5、anilist GraphQL语句存档

#### 原始

```markdown
# 原始
# perPage页数处已经做了修改
query ($ids: [Int]) {
  Page(page: 1, perPage: 1) {
    media(id_in: $ids, type: ANIME) {
      id
      title {
        native
        romaji
        english
      }
      type
      format
      status
      startDate {
        year
        month
        day
      }
      endDate {
        year
        month
        day
      }
      season
      episodes
      duration
      source
      coverImage {
        large
        medium
      }
      bannerImage
      genres
      synonyms
      studios {
        edges {
          isMain
          node {
            id
            name
            siteUrl
          }
        }
      }
      isAdult
      externalLinks {
        id
        url
        site
      }
      siteUrl
    }
  }
}
```

#### 番剧相似推荐(部分)

```markdown
recommendations(perPage: 7, sort: [RATING_DESC, ID]) {
      pageInfo {
        total
      }
      nodes {
        id
        rating
        userRating
        mediaRecommendation {
          id
          title {
            userPreferred
          }
          format
          type
          status(version: 2)
          bannerImage
          coverImage {
            large
          }
        }
        user {
          id
          name
          avatar {
            large
          }
        }
      }
    }
```

#### 最终精简版(json + graphQL)

合并番剧推荐及删掉部分节点

json

```markdown
{
    "data":{
        "Page":{
            "media":[
                {
                    "id":97716,
                    "title":{
                        "native":"月曜日のたわわ",
                        "romaji":"Getsuyoubi no Tawawa",
                        "english":"Tawawa on Monday",
                        "chinese":"月曜日のたわわ"
                    },
                    "type":"ANIME",
                    "format":"ONA",
                    "status":"FINISHED",
                    "startDate":{
                        "year":2016,
                        "month":10,
                        "day":10
                    },
                    "endDate":{
                        "year":2016,
                        "month":12,
                        "day":26
                    },
                    "season":"FALL",
                    "episodes":12,
                    "duration":5,
                    "source":"OTHER",
                    "coverImage":{
                        "large":"https://s4.anilist.co/file/anilistcdn/media/anime/cover/medium/97716-Kf3SXRjuc0TV.jpg",
                        "medium":"https://s4.anilist.co/file/anilistcdn/media/anime/cover/small/97716-Kf3SXRjuc0TV.jpg"
                    },
                    "bannerImage":"https://s4.anilist.co/file/anilistcdn/media/anime/banner/97716-sEp8G2X0wAIk.jpg",
                    "genres":[
                        "Ecchi",
                        "Slice of Life"
                    ],
                    "synonyms":[
                        "週一的 豐饒",
                        "週一的碩果",
                        "週一桃夭夭",
                        "搖搖的週一",
                        "星期一的福利",
                        "星期一的大咪咪",
                        "星期一的豐滿",
                        "軟綿綿的星期一",
                        "搖曳的星期一"
                    ],
                    "isAdult":false,
                    "recommendations":{
                        "pageInfo":{
                            "total":2
                        },
                        "nodes":[
                            {
                                "id":21218,
                                "rating":5,
                                "userRating":"NO_RATING",
                                "mediaRecommendation":{
                                    "id":15005,
                                    "title":{
                                        "native":"今日のあすかショー",
                                        "romaji":"Kyou no Asuka Show",
                                        "english":null
                                    },
                                    "format":"ONA",
                                    "type":"ANIME",
                                    "status":"FINISHED",
                                    "bannerImage":null,
                                    "coverImage":{
                                        "large":"https://s4.anilist.co/file/anilistcdn/media/anime/cover/medium/15005.jpg"
                                    }
                                },
                                "user":{
                                    "id":118119,
                                    "name":"LAEM",
                                    "avatar":{
                                        "large":"https://s4.anilist.co/file/anilistcdn/user/avatar/large/b118119-srEdbsqvpuFK.png"
                                    }
                                }
                            },
                            {
                                "id":60204,
                                "rating":4,
                                "userRating":"NO_RATING",
                                "mediaRecommendation":{
                                    "id":106967,
                                    "title":{
                                        "native":"みるタイツ",
                                        "romaji":"Miru Tights",
                                        "english":null
                                    },
                                    "format":"ONA",
                                    "type":"ANIME",
                                    "status":"FINISHED",
                                    "bannerImage":"https://s4.anilist.co/file/anilistcdn/media/anime/banner/106967-u8AEDAZgtWXX.jpg",
                                    "coverImage":{
                                        "large":"https://s4.anilist.co/file/anilistcdn/media/anime/cover/medium/bx106967-hG1SSeB44Ve5.jpg"
                                    }
                                },
                                "user":{
                                    "id":914807,
                                    "name":"GeminiTheConqueror",
                                    "avatar":{
                                        "large":"https://s4.anilist.co/file/anilistcdn/user/avatar/large/b914807-zhMKOvLVAErX.png"
                                    }
                                }
                            }
                        ]
                    },
                    "externalLinks":[

                    ],
                    "siteUrl":"https://anilist.co/anime/97716"
                }
            ]
        }
    }
}
```

graphQL

```markdown
query ($ids: [Int]) {
        Page(page: 1, perPage: 1) {
            media(id_in: $ids, type: ANIME) {
                id
                title {
                    native
                    romaji
                    english
                    }
                type
                format
                status
                startDate {
                    year
                    month
                    day
                    }
                endDate {
                    year
                    month
                    day
                    }
                season
                episodes
                duration
                source
                coverImage {
                    large
                    medium
                    }
                bannerImage
                genres
                synonyms
                isAdult
                recommendations(perPage: 5, sort: [RATING_DESC, ID]) {
                pageInfo {
                  total
                }
                nodes {
                  id
                  rating
                  userRating
                  mediaRecommendation {
                    id
                    title {
                        native
                        romaji
                        english
                    }
                    format
                    type
                    status(version: 2)
                    bannerImage
                    coverImage {
                      large
                    }
                  }
                  user {
                    id
                    name
                    avatar {
                      large
                    }
                  }
                }
              }
                externalLinks {
                    id
                    url
                    site
                    }
                siteUrl
                }
            }
        }
```

